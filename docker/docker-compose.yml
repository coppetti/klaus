# IDE Agent Wizard - Docker Compose
# ==================================
# Telegram bot with Kimi Agent (port 8081) + Memory Sync
# Run from project root: docker compose -f docker/docker-compose.yml up -d

version: '3.8'

services:
  # Kimi Agent Service (Patched for AGENTS.md support)
  # Build from local Dockerfile with AGENTS.md support
  kimi-agent:
    build:
      context: ./kimi-agent-patch
      dockerfile: Dockerfile
    container_name: ide-agent-kimi
    ports:
      - "8081:8080"
    volumes:
      # Sync memory with host
      - ../workspace/memory:/app/memory:rw
      - ../workspace:/app/workspace:ro
      # Mount docs for AGENTS.md access
      - ../docs:/app/docs:ro
      # Mount projects folder (read-write for IDE access)
      - ../workspace/projects:/app/workspace/projects:rw
    env_file:
      - ../.env
    environment:
      - MEMORY_PATH=/app/memory
      - SOUL_MD_PATH=/app/workspace/SOUL.md
      - USER_MD_PATH=/app/workspace/USER.md
      - AGENTS_MD_PATH=/app/docs/AGENTS.md
      - CLAWD_WORKSPACE=/app/workspace
      - PROJECTS_PATH=/app/workspace/projects
    restart: unless-stopped
    # Healthcheck removed - container works but doesn't have curl

  # Telegram Bot
  telegram-bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: ide-agent-telegram
    
    volumes:
      # Mount workspace for file access
      - ../workspace:/app/workspace:rw
      # Mount memory for persistence (sync with kimi-agent)
      - ../workspace/memory:/app/workspace/memory:rw
      # Mount init.yaml
      - ../init.yaml:/app/init.yaml:ro
      # Mount docs for AGENTS.md access
      - ../docs:/app/docs:ro
      # Mount projects folder (shared with kimi-agent)
      - ../workspace/projects:/app/workspace/projects:rw
    
    env_file:
      - ../.env
    
    environment:
      # Kimi Agent URL (internal docker network)
      - KIMI_AGENT_URL=http://kimi-agent:8080
      
      # Optional: Override config
      - AGENT_MODE=telegram
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.path.insert(0, '.'); from core.agent import Agent; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Networks
networks:
  default:
    name: ide-agent-network
