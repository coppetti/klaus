# IDE Agent Wizard - Docker Compose
# ==================================
# Telegram bot with Kimi Agent (port 8081) + Memory Sync
# Run from project root: docker compose -f docker/docker-compose.yml up -d

version: "3.8"
name: klaus

services:
  # Kimi Agent Service (Patched for AGENTS.md support)
  # Build from local Dockerfile with AGENTS.md support
  kimi-agent:
    build:
      context: ./kimi-agent-patch
      dockerfile: Dockerfile
    container_name: KLAUS_MAIN_kimi
    ports:
      - "7070:8080"
    volumes:
      # Sync memory with host
      - ../workspace/memory:/app/memory:rw
      - ../workspace:/app/workspace:ro
      # Mount core modules for shared logic
      - ../core:/app/core:ro
      # Mount projects folder (read-write for IDE access)
      - ../workspace/projects:/app/workspace/projects:rw
    env_file:
      - ../.env
    environment:
      - MEMORY_PATH=/app/memory
      - SOUL_MD_PATH=/app/workspace/SOUL.md
      - USER_MD_PATH=/app/workspace/USER.md
      - AGENTS_MD_PATH=/app/docs/AGENTS.md
      - CLAWD_WORKSPACE=/app/workspace
      - PROJECTS_PATH=/app/workspace/projects
    restart: unless-stopped
    networks:
      default:
        aliases:
          - kimi-agent
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Telegram Bot
  telegram-bot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: KLAUS_MAIN_telegram

    volumes:
      # Mount workspace for file access
      - ../workspace:/app/workspace:rw
      # Mount memory for persistence (sync with kimi-agent)
      - ../workspace/memory:/app/workspace/memory:rw
      # Mount init.yaml
      - ../init.yaml:/app/init.yaml:ro
      # Mount docs for AGENTS.md access
      - ../docs:/app/docs:ro
      # Mount projects folder (shared with kimi-agent)
      - ../workspace/projects:/app/workspace/projects:rw

    env_file:
      - ../.env

    environment:
      # Kimi Agent URL (internal docker network)
      - KIMI_AGENT_URL=http://KLAUS_MAIN_kimi:8080

      # Optional: Override config
      - AGENT_MODE=telegram

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "python", "-c", "import os; from bot.telegram_bot import TelegramBot; print('OK')"]
      interval: 60s
      timeout: 20s
      retries: 5
      start_period: 30s

  # Web UI Service (Browser interface)
  web-ui:
    build:
      context: ./web-ui
      dockerfile: Dockerfile
    container_name: KLAUS_MAIN_web
    ports:
      - "7072:8082"
    volumes:
      # Mount workspace for data persistence (sessions, settings)
      - ../workspace:/app/workspace:rw
      - ../init.yaml:/app/init.yaml:ro
      # Mount core modules for hybrid memory access
      - ../core:/app/core:ro
      # Mount templates for agent selection
      - ../templates:/app/templates:ro
    env_file:
      - ../.env
    environment:
      - KIMI_AGENT_URL=http://KLAUS_MAIN_kimi:8080
      - WEB_UI_PORT=8082
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8082/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      - kimi-agent
    profiles:
      - web # Only starts with --profile web

# Networks
networks:
  default:
    name: KLAUS_MAIN_network
