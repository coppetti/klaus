"""
CI/CD Pipeline - Klaus Project
Chuck Norris doesn't need CI/CD. His code is always perfect.
But we mortals need this.
"""
name: CI - Klaus

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11"
  KLAUS_IMAGE: klaus

jobs:
  # =============================================================================
  # PRE-CHECKS
  # =============================================================================
  pre-checks:
    name: Pre-Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check commit message format
        run: |
          # Check if commit message follows conventional commits
          git log -1 --pretty=%B | grep -E "^(feat|fix|docs|test|refactor|chore|ci)(\(.+\))?: .+" || echo "⚠️ Warning: Commit message doesn't follow conventional commits"
      
      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # =============================================================================
  # CODE QUALITY
  # =============================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: pre-checks
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install black ruff mypy bandit
      
      - name: Run Black (format check)
        run: |
          black --check --diff core/ bot/ docker/
        continue-on-error: true
      
      - name: Run Ruff (lint)
        run: |
          ruff check core/ bot/ docker/
        continue-on-error: true
      
      - name: Run MyPy (type check)
        run: |
          mypy core/ --ignore-missing-imports
        continue-on-error: true
      
      - name: Run Bandit (security)
        run: |
          bandit -r core/ -f json -o bandit-report.json || true
          cat bandit-report.json || echo "No report"

  # =============================================================================
  # UNIT TESTS
  # =============================================================================
  unit-tests:
    name: Unit Tests (Coverage 75%+)
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-html
      
      - name: Run Unit Tests
        run: |
          pytest tests/unit/ \
            -v \
            --cov=core \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=75 \
            --html=reports/unit-tests.html
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-py${{ matrix.python-version }}
          path: |
            reports/
            htmlcov/

  # =============================================================================
  # INTEGRATION TESTS
  # =============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      # No external services, everything is Docker
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx
      
      - name: Build Docker images
        run: |
          docker compose -f docker/docker-compose.yml build
      
      - name: Start services
        run: |
          docker compose -f docker/docker-compose.yml --profile web up -d
          sleep 15  # Wait for services to start
      
      - name: Check service health
        run: |
          docker ps
          curl -f http://localhost:7070/health || echo "Kimi agent not healthy"
          curl -f http://localhost:7072/health || echo "Web UI not healthy"
      
      - name: Run Integration Tests
        run: |
          pytest tests/integration/ \
            -v \
            --tb=short \
            -m integration \
            --html=reports/integration-tests.html
        continue-on-error: true
      
      - name: Stop services
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: reports/

  # =============================================================================
  # E2E TESTS
  # =============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx
      
      - name: Build Docker images
        run: |
          docker compose -f docker/docker-compose.yml build
      
      - name: Start full stack
        run: |
          docker compose -f docker/docker-compose.yml --profile web up -d
          sleep 20
      
      - name: Run E2E Tests
        run: |
          pytest tests/e2e/ \
            -v \
            --tb=short \
            -m e2e \
            --html=reports/e2e-tests.html
        timeout-minutes: 10
        continue-on-error: true
      
      - name: Stop services
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: reports/

  # =============================================================================
  # SECURITY SCAN
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: pre-checks
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Scan Docker images
        run: |
          docker build -t klaus-test -f docker/Dockerfile .
          # Basic scan
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image klaus-test || true

  # =============================================================================
  # BUILD & PUSH
  # =============================================================================
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build images
        run: |
          docker compose -f docker/docker-compose.yml build
      
      - name: Test images
        run: |
          docker images | grep klaus
      
      - name: Create release archive
        run: |
          mkdir -p dist
          tar -czf dist/klaus-$(date +%Y%m%d-%H%M%S).tar.gz \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='dist' \
            .
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: dist/

  # =============================================================================
  # DEPLOY STAGING
  # =============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [e2e-tests, build]
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment commands here
          # ssh user@staging-server "cd /app && docker compose pull && docker compose up -d"
      
      - name: Smoke test staging
        run: |
          echo "Running smoke tests on staging..."
          # curl -f https://staging.klaus.example.com/health

  # =============================================================================
  # SUMMARY
  # =============================================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
